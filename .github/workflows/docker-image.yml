name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: # 允许手动点击运行

jobs:
  # 第一阶段：环境检查、自动构建并更新 README
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 使用内置的 GITHUB_TOKEN，修复之前 "token not supplied" 的报错
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install and Build
        run: |
          npm install
          npm run lint || echo "Lint skipped"
          npm run build

      - name: Auto Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: automatic file changes [ci skip]'
          file_pattern: ':/*.*'

  # 第二阶段：构建并推送多架构镜像
  build-and-push:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3 # 关键：让 GitHub 支持构建 arm64 镜像

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # 构建同时兼容 PC (amd64) 和 绿联 NAS (arm64) 的镜像
          platforms: linux/amd64,linux/arm64
          # --- 彻底修复 Size Validation 1218 != 1182 的核心配置 ---
          provenance: false # 关闭证明文件，消除 unknown 架构
          sbom: false       # 关闭软件账单，减少校验干扰
          no-cache: true    # 强制不使用旧缓存，确保清单文件重新生成
          # 使用全新的 cache scope，彻底抛弃之前那 61 个损坏的缓存块
          cache-from: type=gha,scope=build-v2024-final-fix
          cache-to: type=gha,mode=max,scope=build-v2024-final-fix
          # ---------------------------------------------------
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/how-to-cook:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/how-to-cook:${{ github.sha }}